{% load static %}

<div id="spinner-container" class="spinner-container">
    <div class="spinner"></div>
</div>

{% block content %}
{% include 'components/scheduler-editor.html' %}
{% endblock %}

<script src="{% static 'js/recurring-control.js' %}"></script>
<script src="{% static 'js/appointment.js' %}"></script>
<script>
    let clientSearch;
    let locationSearch;
    document.addEventListener('DOMContentLoaded', function () {
        const resourceData = JSON.parse('{{ clinicians|safe }}');
        const clientData = JSON.parse('{{ clients|safe }}');
        const locationData = JSON.parse('{{ locations|safe }}');
        const teamMemberData = JSON.parse('{{ team_members|safe }}');

        let currentResourceId = null;
        // Initialize Scheduler
        const scheduler = new ej.schedule.Schedule({
            width: '100%',
            height: '100%',
            selectedDate: new Date(),
            cssClass: 'tailwind-scheduler',
            currentView: 'Day',
            views: [
                { option: 'Day' },
                { option: 'Week' },
                { option: 'Month' }
            ],
            group: {
                resources: ['Resources']
            },
            resources: [{
                field: 'ResourceId',
                title: 'Clinicians',
                name: 'Resources',
                dataSource: resourceData,
                textField: 'text',
                idField: 'id',
                colorField: 'color'
            }],
            timezone: 'America/New_York',
            eventSettings: {
                dataSource: [],
                fields: {
                    id: 'Id',
                    startTime: { name: 'StartTime' },
                    endTime: { name: 'EndTime' },
                    isAllDay: { name: 'IsAllDay' },
                    resourceId: { name: 'ResourceId' }
                },
                enableRecurrenceValidation: true
            },
            editorTemplate: '#EventEditorTemplate',
            popupOpen: function (args) {
                if (args.type === 'Editor') {
                    initializeEditorComponents(args);
                    // Store the resourceId from args
                    currentResourceId = args.data.ResourceId;
                }
                if (args.type === 'QuickInfo') {
                    args.cancel = true;
                }
            },
            actionBegin: function (args) {
                if (args.requestType === 'eventCreate' || args.requestType === 'eventChange' || args.requestType === 'eventRemove') {
                    const eventData = args.data[0] || args.data;
                    // Determine the active tab and set the eventType accordingly
                    const activeTab = document.querySelector('.editor-tab.active').getAttribute('data-tab');
                    let eventType;

                    switch (activeTab) {
                        case 'appointment':
                            eventType = 'APPOINTMENT';
                            break;
                        case 'event':
                            eventType = 'EVENT';
                            break;
                        case 'out_of_office':
                            eventType = 'OUT_OF_OFFICE';
                            break;
                        default:
                            eventType = 'APPOINTMENT';
                    }
                    document.getElementById('spinner-container').style.display = 'flex';
                    fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            action: action,
                            eventType: eventType,
                            ...recurrenceData,
                            resourceId: resourceId
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Refresh the calendar data after successful creation
                                fetch(window.location.href, {
                                    headers: {
                                        'X-Requested-With': 'XMLHttpRequest'
                                    }
                                })
                                    .then(response => response.json())
                                    .then(updatedData => {
                                        scheduler.eventSettings.dataSource = updatedData;
                                        scheduler.dataBind();
                                    })
                                    .catch(error => {
                                        console.error('Error loading updated events:', error);
                                    });
                            }
                            document.getElementById('spinner-container').style.display = 'none';
                        });
                }
            },
            timeScale: {
                enable: true,
                interval: 60,
                slotCount: window.innerWidth < 768 ? 1 : 2
            },
            rowAutoHeight: false,
            allowResizing: window.innerWidth >= 768,
            allowDragAndDrop: window.innerWidth >= 768
        });

        scheduler.appendTo('#scheduler');

        // Load initial events
        const currentDate = scheduler.selectedDate;
        const selectedView = scheduler.currentView;

        const { startDate, endDate } = getStartAndEndDates(currentDate, selectedView);

        // Fetch events for the selected date range
        fetch(`${window.location.href}?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                scheduler.eventSettings.dataSource = data;
                scheduler.dataBind();
            })
            .catch(error => {
                console.error('Error loading events:', error);
            });

        // Update navigationClick method
        scheduler.navigationClick = function (args) {
            const selectedView = scheduler.currentView;
            const selectedDate = scheduler.selectedDate;

            const { startDate, endDate } = getStartAndEndDates(selectedDate, selectedView);

            // Fetch events for the selected date range
            fetch(`${window.location.href}?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}`, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    scheduler.eventSettings.dataSource = data;
                    scheduler.dataBind();
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                });
        };

        // Update navigating method
        scheduler.navigating = function (args) {
            if (args.action === 'date' || args.action === 'view') {
                const selectedDate = args.currentDate || scheduler.selectedDate;
                let selectedView;

                // Determine the view based on the action
                if (args.action === 'view') {
                    selectedView = args.currentView;
                } else {
                    selectedView = scheduler.currentView;
                }

                const { startDate, endDate } = getStartAndEndDates(selectedDate, selectedView);

                fetch(`${window.location.href}?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        scheduler.eventSettings.dataSource = data;
                        scheduler.dataBind();
                    })
                    .catch(error => {
                        console.error('Error loading events:', error);
                    });
            }
        };

        // Handle window resize
        window.addEventListener('resize', function () {
            scheduler.timeScale.slotCount = window.innerWidth < 768 ? 1 : 2;
            scheduler.allowResizing = window.innerWidth >= 768;
            scheduler.allowDragAndDrop = window.innerWidth >= 768;
            scheduler.dataBind();
        });

      
        $(document).on('click', '#appointment-done-button', function () {
            // Clear any existing error messages
            clearErrorMessages();

            // Get selected client and location
            const selectedClient = clientSearch.getSelectedItem();
            const selectedLocation = locationSearch.getSelectedItem();

            // Call the createAppointment function
            createAppointment(selectedClient, selectedLocation, scheduler);
        });
        
        $(document).on('click', '#cancel-button', function () {
            scheduler.closeEditor();
        });

        // Initialize editor components
        function initializeEditorComponents(args) {
            const container = args.element;

            // Initialize all components

            // Tab Navigation
            const tabs = document.querySelectorAll('.tab-link');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                });
            });

            // Appointment Type Selection
            const typeButtons = document.querySelectorAll('.type-btn');
            typeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    typeButtons.forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                });
            });


            initializeClientSearch(clientData);
            initializeDateTimePicker(args.data);
            initializeLocationDropdown(locationData);
            initializeRecurringControl(args.data.StartTime);
        }

    });
</script>
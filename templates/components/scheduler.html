{% load static %}

<div id="spinner-container" class="spinner-container">
    <div class="spinner"></div>
</div>

{% block content %}
{% include 'components/scheduler-editor.html' %}
{% include 'components/appointment-modal.html' %}
{% endblock %}

<script src="{% static 'js/recurring-control.js' %}"></script>
<script src="{% static 'js/appointment.js' %}"></script>
<script src="{% static 'js/event.js' %}"></script>
<script src="{% static 'js/out-of-office.js' %}"></script>
<script src="{% static 'js/practice_services.js' %}"></script>
<script src="{% static 'js/recurring-summary.js' %}"></script>
<script src="{% static 'js/appointment-modal.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const resourceData = JSON.parse('{{ clinicians|safe }}');
        const clientData = JSON.parse('{{ clients|safe }}');
        const locationData = JSON.parse('{{ locations|safe }}');
        const teamMemberData = JSON.parse('{{ team_members|safe }}');

        let currentResourceId = null;
        // Initialize Scheduler
        const scheduler = new ej.schedule.Schedule({
            width: '100%',
            height: '100%',
            selectedDate: new Date(),
            cssClass: 'tailwind-scheduler',
            currentView: 'Day',
            views: [
                { option: 'Day' },
                { option: 'Week' },
                { option: 'Month' }
            ],
            group: {
                resources: ['Resources']
            },
            resources: [{
                field: 'ResourceId',
                title: 'Clinicians',
                name: 'Resources',
                dataSource: resourceData,
                textField: 'text',
                idField: 'id',
                colorField: 'color'
            }],
            timezone: 'America/New_York',
            eventSettings: {
                dataSource: [],
                fields: {
                    id: 'Id',
                    resourceId: { name: 'ResourceId' }
                }
            },
            editorTemplate: '#EventEditorTemplate',
            popupOpen: function (args) {
                if (args.type === 'Editor') {
                    // Initially hide the popup while data is loading
                    if (args.element) {
                        args.element.style.display = 'none';
                    }
                    initializeEditorComponents(args)
                        .then(() => {
                            currentResourceId = args.data.ResourceId;
                            if (args.element) {
                                args.element.style.display = 'flex';
                            }
                        })
                        .catch(() => {
                        });
                }
                if (args.type === 'QuickInfo') {
                    args.cancel = true;
                }
            },
            actionBegin: function (args) {
                if (args.requestType === 'eventCreate' || args.requestType === 'eventChange' || args.requestType === 'eventRemove') {
                    const eventData = args.data[0] || args.data;
                    const action = args.requestType.replace('event', '').toLowerCase();
                    const resourceId = currentResourceId;

                    showSpinner();
                    fetch(window.location.href, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            action: action,
                            eventData: eventData,
                            resourceId: resourceId
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Refresh the calendar data after successful creation
                                fetchAndUpdateEvents();
                            }
                        })
                        .finally(() => {
                            hideSpinner();
                        });
                }
            },
            timeScale: {
                enable: true,
                interval: 60,
                slotCount: window.innerWidth < 768 ? 1 : 2
            },
            rowAutoHeight: false,
            allowResizing: window.innerWidth >= 768,
            allowDragAndDrop: window.innerWidth >= 768
        });

        // Central function to fetch and update events
        async function fetchAndUpdateEvents(selectedDate = scheduler.selectedDate, selectedView = scheduler.currentView) {
            try {
                const { startDate, endDate } = getStartAndEndDates(selectedDate, selectedView);
                const response = await fetch(
                    `${window.location.href}?start_date=${startDate.toISOString()}&end_date=${endDate.toISOString()}`,
                    {
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    }
                );
                const data = await response.json();
                scheduler.eventSettings.dataSource = data;
                scheduler.dataBind();
                scheduler.closeEditor(); // Close editor if open
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        scheduler.appendTo('#scheduler');

        // Load initial events
        fetchAndUpdateEvents();

        // Update navigationClick method
        scheduler.navigationClick = function (args) {
            fetchAndUpdateEvents();
        };

        // Update navigating method
        scheduler.navigating = function (args) {
            if (args.action === 'date' || args.action === 'view') {
                const selectedDate = args.currentDate || scheduler.selectedDate;
                const selectedView = args.action === 'view' ? args.currentView : scheduler.currentView;
                fetchAndUpdateEvents(selectedDate, selectedView);
            }
        };
        // Handle window resize
        window.addEventListener('resize', function () {
            scheduler.timeScale.slotCount = window.innerWidth < 768 ? 1 : 2;
            scheduler.allowResizing = window.innerWidth >= 768;
            scheduler.allowDragAndDrop = window.innerWidth >= 768;
            scheduler.dataBind();
        });


        $(document).on('click', '#done-button', function () {
            showSpinner();
            // Clear any existing error messages
            clearErrorMessages();

            // Determine which tab is active
            const activeTab = document.querySelector('.tab-link.active').textContent.toLowerCase();
            const eventId = document.getElementById('event-id').value;
            const eventType = document.getElementById('event-type').value;

            let selectedClient, selectedLocation, selectedTeamMember;

            // Get selected client and location based on the active tab
            if (eventId ? eventType === 'APPOINTMENT' : activeTab === 'appointment') {
                selectedClient = clientSearch.getSelectedItem();
                selectedLocation = locationSearch.getSelectedItem();
                if (eventId) {
                    updateAppointment(selectedLocation, scheduler).then(() => {
                        scheduler.closeEditor();
                    }).catch(() => {
                        scheduler.closeEditor();
                    })
                } else {
                    createAppointment(selectedClient, selectedLocation, scheduler).then(() => {
                        scheduler.closeEditor();
                    }).catch(() => {
                        scheduler.closeEditor();
                    })
                }
            } else if (eventId ? eventType === 'EVENT' : activeTab === 'event') {
                selectedLocation = eventLocationSearch.getSelectedItem();
                selectedTeamMember = eventTeamMemberSearch.getSelectedItem();
                const eventName = document.getElementById('event-name').value;
                if (eventId) {
                    updateEvent(selectedLocation, selectedTeamMember, scheduler).then(() => {
                        scheduler.closeEditor();
                    }).catch(() => {
                        scheduler.closeEditor();
                    })
                }
                else {
                    createEvent(selectedLocation, selectedTeamMember, scheduler).then(() => {
                        scheduler.closeEditor();
                    }).catch(() => {
                        scheduler.closeEditor();
                    })
                }
            } else if (activeTab === 'out of office') {
                selectedTeamMember = oofTeamMemberSearch.getSelectedItem();
                createOutOfOffice(selectedTeamMember, scheduler);
            }
            hideSpinner();
        });

        $(document).on('click', '#cancel-button', function () {
            scheduler.closeEditor();
        });

        $(document).on('click', '#delete-button', function () {
            showSpinner();
            // Determine which tab is active
            const eventId = document.getElementById('event-id').value;
            const eventType = document.getElementById('event-type').value;
            if (eventType === 'APPOINTMENT') {
                deleteAppointment(scheduler).then(() => {
                    scheduler.closeEditor();
                }).catch(() => {
                    scheduler.closeEditor();
                });
            }
            else if (eventType === 'EVENT') {
                deleteEvent(scheduler).then(() => {
                    scheduler.closeEditor();
                }).catch(() => {
                    scheduler.closeEditor();
                });
            }
            hideSpinner();
        });

        // Initialize editor components
        function initializeEditorComponents(args) {
            return new Promise((resolve, reject) => {
                const container = args.element;
                const isExistingEvent = args.data.Id ? true : false;

                try {
                    // Initialize all components
                    initializeClientSearch(clientData);
                    initializeDateTimePicker(args.data);
                    initializeLocationDropdown(locationData);
                    initializeRecurringControl(args.data.StartTime);

                    // Initialize event components
                    initializeEventDateTimePicker(args.data);
                    initializeEventLocationDropdown(locationData);
                    initializeEventTeamMemberDropdown(teamMemberData);

                    // Initialize out of office components
                    initializeOutOfOfficeDateTimePicker(args.data);
                    initializeOutOfOfficeTeamMemberDropdown(teamMemberData);

                    if (isExistingEvent) {
                        // Hide tab navigation and type selection for existing events
                        const tabNavigation = container.querySelector('.tab-navigation');
                        const typeSelection = container.querySelector('.type-selection');
                        const searchSection = container.querySelector('.search-section');
                        const clientDetails = container.querySelector('.client-details-container');
                        const eventId = container.querySelector('#event-id');
                        const eventType = container.querySelector('#event-type');

                        if (tabNavigation) tabNavigation.style.display = 'none';
                        if (typeSelection) typeSelection.style.display = 'none';
                        if (searchSection) searchSection.style.display = 'none';
                        if (clientDetails) clientDetails.style.display = 'block';
                        if (eventId) eventId.value = args.data.Id;
                        if (eventType) eventType.value = args.data.Type;

                        loadEventData(args.data.Id, container)
                            .then(() => resolve())
                            .catch(error => reject(error));
                    } else {
                        // For new events, show tab navigation and initialize it
                        initializeTabNavigation(args.data);
                        resolve();
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }

    });

    function initializeTabNavigation(dateData) {
        const tabs = document.querySelectorAll('.tab-link');
        const appointmentSection = document.querySelector('.appointment-section');
        const outOfOfficeSection = document.querySelector('.out-of-office-section');
        const eventSection = document.querySelector('.event-section');
        const recurringSection = document.querySelector('#recurring-section');
        const servicesSection = document.querySelector('.services-section');

        tabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const tabType = tab.textContent.toLowerCase();

                // Clear any existing error messages
                clearErrorMessages();

                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');


                // Show/hide and reinitialize appropriate sections
                if (tabType === 'appointment') {
                    appointmentSection.style.display = 'block';
                    eventSection.style.display = 'none';
                    outOfOfficeSection.style.display = 'none';
                    recurringSection.style.display = 'block';

                    reInitializeAppointment(dateData);
                    reInitializeRecurringControl(dateData.StartTime);
                    reInitializePracticeServices();

                } else if (tabType === 'event') {
                    appointmentSection.style.display = 'none';
                    eventSection.style.display = 'block';
                    outOfOfficeSection.style.display = 'none';
                    recurringSection.style.display = 'block';
                    servicesSection.style.display = 'none';

                    reInitializeEventComponents(dateData);
                    reInitializeRecurringControl(dateData.StartTime);

                } else { // Out of office
                    appointmentSection.style.display = 'none';
                    eventSection.style.display = 'none';
                    outOfOfficeSection.style.display = 'block';
                    recurringSection.style.display = 'none';
                    servicesSection.style.display = 'none';

                    reInitializeOutOfOfficeComponents(dateData);
                }
            });
        });
    }
</script>